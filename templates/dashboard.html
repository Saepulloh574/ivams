<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Monitoring Dashboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .dashboard-container {
            width: 100%;
            max-width: 800px;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #1e88e5;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        .status-box {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .status-item {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .status-item h4 {
            margin: 0 0 5px 0;
            color: #1e88e5;
            font-size: 0.9em;
            text-transform: uppercase;
        }
        .status-item p {
            margin: 0;
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }
        .status-main {
            background-color: #bbdefb;
            grid-column: 1 / -1;
        }
        .actions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            text-align: center;
            text-decoration: none;
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn:hover {
            background-color: #45a049;
            transform: translateY(-1px);
        }
        .btn.blue { background-color: #1e88e5; }
        .btn.blue:hover { background-color: #1565c0; }
        .btn.red { background-color: #e53935; }
        .btn.red:hover { background-color: #c62828; }
        .btn.yellow { background-color: #ffb300; }
        .btn.yellow:hover { background-color: #ff8f00; }
        .log-box {
            margin-top: 30px;
            padding: 15px;
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        #log {
            height: 250px;
            overflow-y: scroll;
            background-color: #212121;
            color: #e0e0e0;
            padding: 10px;
            border-radius: 6px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 0.8em;
            white-space: pre-wrap;
        }
        .log-line.error { color: #ff5252; }
        .log-line.action { color: #4fc3f7; }
        .log-line.success { color: #a5d6a7; }

        @media (max-width: 600px) {
            .dashboard-container {
                padding: 15px;
            }
            .status-item p {
                font-size: 1.2em;
            }
            .action-buttons {
                flex-direction: column;
            }
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <h1>üöÄ Bot Monitoring Dashboard</h1>

        <div class="status-box">
            <div id="status-main" class="status-item status-main">
                <h4>Status Bot</h4>
                <p>Initializing...</p>
            </div>
            <div id="status-uptime" class="status-item">
                <h4>Uptime</h4>
                <p>--</p>
            </div>
            <div id="status-otps" class="status-item">
                <h4>Total OTPs Sent</h4>
                <p>0</p>
            </div>
            <div id="status-last-check" class="status-item">
                <h4>Last Check</h4>
                <p>--</p>
            </div>
            <div id="status-cache" class="status-item">
                <h4>Cache Size</h4>
                <p>0</p>
            </div>
        </div>

        <div class="actions-header">
            <h2>‚öôÔ∏è Bot Actions</h2>
        </div>

        <div class="action-buttons">
            <a href="#" class="btn blue" id="refresh-screenshot-btn">üîÑ Refresh & Screenshot</a>
            
            <a href="#" class="btn blue" id="send-status-btn">üì¢ Send Telegram Status</a>
            <a href="#" class="btn yellow" id="test-message-btn">üì§ Test Message</a>
            <a href="#" class="btn red" id="clear-cache-btn">üóëÔ∏è Clear OTP Cache</a>
            <a href="#" class="btn red" id="stop-monitor-btn">‚è∏Ô∏è Stop Monitoring</a>
            <a href="#" class="btn green" id="start-monitor-btn">‚ñ∂Ô∏è Start Monitoring</a>
        </div>

        <div class="log-box">
            <h2>üìú Activity Log</h2>
            <pre id="log">Log window loaded.</pre>
        </div>
    </div>

    <script>
        const API_STATUS_URL = '/api/status';
        const logElement = document.getElementById('log');

        function log(message, type = 'default') {
            const now = new Date();
            const timestamp = `[${String(now.getHours()).padStart(2, '0')}.${String(now.getMinutes()).padStart(2, '0')}.${String(now.getSeconds()).padStart(2, '0')}]`;
            const line = document.createElement('span');
            line.classList.add('log-line', type);
            line.textContent = `${timestamp} ${message}`;
            logElement.appendChild(line);
            logElement.appendChild(document.createElement('br'));
            // Auto-scroll ke bawah
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus(data) {
            document.querySelector('#status-main p').textContent = data.status;
            document.querySelector('#status-uptime p').textContent = data.uptime;
            document.querySelector('#status-otps p').textContent = data.total_otps_sent;
            document.querySelector('#status-last-check p').textContent = data.last_check;
            document.querySelector('#status-cache p').textContent = data.cache_size;

            // Update warna status
            const mainBox = document.getElementById('status-main');
            mainBox.style.backgroundColor = data.status.includes('Running') ? '#bbdefb' : '#ffcdd2'; // Biru atau Merah Muda
        }

        async function fetchStatus() {
            try {
                const response = await fetch(API_STATUS_URL);
                const data = await response.json();
                updateStatus(data);
                log(`Status updated - ${data.total_otps_sent} OTPs sent`, 'success');
            } catch (error) {
                log(`ERROR: Could not fetch status. Bot down? (${error.message})`, 'error');
            }
        }

        async function handleAction(url, actionName, logType = 'action') {
            log(`Action: ${actionName}`, 'action');
            try {
                const response = await fetch(url);
                const result = await response.json();
                if (response.ok) {
                    log(`SUCCESS: ${result.message}`, 'success');
                } else {
                    log(`ERROR: HTTP Error: ${response.status} (${result.message || 'Unknown error'})`, 'error');
                }
            } catch (error) {
                log(`ERROR: Connection failed for ${actionName}. (${error.message})`, 'error');
            }
            // Selalu update status setelah action (sinkron atau asinkron)
            setTimeout(fetchStatus, 1000); 
        }

        document.getElementById('refresh-screenshot-btn').addEventListener('click', (e) => {
            e.preventDefault();
            handleAction('/manual-check', 'üîÑ Refresh & Screenshot');
        });

        document.getElementById('send-status-btn').addEventListener('click', (e) => {
            e.preventDefault();
            handleAction('/telegram-status', 'üì¢ Send Telegram Status');
        });

        document.getElementById('test-message-btn').addEventListener('click', (e) => {
            e.preventDefault();
            handleAction('/test-message', 'üì§ Test Message');
        });

        document.getElementById('clear-cache-btn').addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm("Are you sure you want to clear the OTP cache?")) {
                handleAction('/clear-cache', 'üóëÔ∏è Clear OTP Cache', 'error');
            }
        });
        
        document.getElementById('stop-monitor-btn').addEventListener('click', (e) => {
            e.preventDefault();
            handleAction('/stop-monitor', '‚è∏Ô∏è Stop Monitoring', 'error');
        });

        document.getElementById('start-monitor-btn').addEventListener('click', (e) => {
            e.preventDefault();
            handleAction('/start-monitor', '‚ñ∂Ô∏è Start Monitoring', 'success');
        });

        // Initial load and set interval
        log('Bot Dashboard Loaded', 'success');
        log('Checking connection status...', 'action');
        fetchStatus();
        setInterval(fetchStatus, 5000); // Update status setiap 5 detik
    </script>
</body>
</html>
